<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ညောင်တုန်းကျောင်းတိုက် သံဃာတော်များ</title>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.cdnfonts.com/css/padauk' );
        body {
            font-family: 'Padauk', sans-serif;
            background-color: #111827; /* Dark background */
            color: #d1d5db; /* Light text */
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }
        .table-container {
            overflow-x: auto; /* Enable horizontal scrolling on small screens */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Minimum width to prevent cramping */
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #374151; /* Darker border */
        }
        thead {
            background-color: #1f2937; /* Darker header */
        }
        th {
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tbody tr:hover {
            background-color: #374151; /* Hover effect */
        }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        select {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.375rem;
            padding: 0.6rem 1rem;
            color: #d1d5db;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
        }
        .copy-button {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1.5rem;
            transition: background-color 0.2s;
        }
        .copy-button:hover {
            background-color: #4338ca;
        }
        .total-count {
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            color: #f59e0b; /* Amber color for emphasis */
        }
        .error {
            color: #ef4444; /* Red for errors */
            margin-top: 1rem;
            background-color: #3f3f46;
            padding: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold mb-2 text-white">ပါဠိတက္ကသိုလ်ညောင်တုန်းကျောင်းတိုက်</h1>
        <p class="text-lg mb-6 text-gray-400">၁၃၈၇ (၂၀၂၅) ခုနှစ် သံဃာစာရင်း</p>

        <div id="totalCount" class="total-count"></div>

        <!-- Filters -->
        <div class="filter-container">
            <select id="classFilter" onChange="applyFilters()">
                <option value="">အတန်းအားလုံး</option>
            </select>
            <select id="schoolFilter" onChange="applyFilters()">
                <option value="">ကျောင်းအားလုံး</option>
            </select>
            <select id="subjectCountFilter" onChange="applyFilters()">
                <option value="">ဘာသာရပ် အရေအတွက်</option>
                <option value="4">၄ ဘာသာ</option>
                <option value="3">၃ ဘာသာ</option>
                <option value="2">၂ ဘာသာ</option>
                <option value="1">၁ ဘာသာ</option>
                <option value="custom">ဘာသာရပ်ဖြင့်ရှာရန်</option>
            </select>
            <select id="customSubjectFilter" style="display:none;" onChange="applyFilters()">
                <option value="">ဘာသာရပ် ရွေးပါ</option>
                <option value="P">ပါ</option>
                <option value="TH">သီ</option>
                <option value="N">ဏီ</option>
                <option value="O">သစ်/ဟောင်း</option>
            </select>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>စဉ်</th>
                        <th>နာမည်</th>
                        <th>အတန်း</th>
                        <th>ကျောင်း</th>
                        <th>ခုံနံပါတ်</th>
                        <th>ပါ</th>
                        <th>သီ</th>
                        <th>ဏီ</th>
                        <th>သစ်/ဟောင်း</th>
                    </tr>
                </thead>
                <tbody id="studentBody"></tbody>
            </table>
        </div>

        <div id="errorMessage" class="error"></div>
        <button id="copyButton" class="copy-button" onclick="copyTable()">လက်ရှိစာရင်းကို ကူးယူမည်</button>
    </div>

    <script>
        let allData = [];

        const loadStudents = () => {
            const tableBody = document.getElementById('studentBody');
            const errorDiv = document.getElementById('errorMessage');
            const classFilter = document.getElementById('classFilter');
            const schoolFilter = document.getElementById('schoolFilter');

            fetch('students.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (result) => {
                            if (result.errors.length > 0) {
                                console.error('CSV parsing errors:', result.errors);
                                errorDiv.textContent = `CSV ဖိုင်ကို ဖတ်ရာတွင် အမှားအယွင်းများရှိနေပါသည်: ${result.errors[0].message}`;
                            }
                            
                            allData = result.data.map(row => ({
                                Name: row.Name || '',
                                Class: row.Class || '',
                                School: row.School || '',
                                C_Num: row.C_Num || '',
                                P: row.P || '',
                                TH: row.TH || '',
                                N: row.N || '',
                                O: row.O || ''
                            }));

                            // Populate dropdowns with unique values
                            const uniqueClasses = [...new Set(allData.map(student => student.Class).filter(Boolean))].sort();
                            const uniqueSchools = [...new Set(allData.map(student => student.School).filter(Boolean))].sort();
                            
                            uniqueClasses.forEach(cls => {
                                const option = document.createElement('option');
                                option.value = cls;
                                option.textContent = cls;
                                classFilter.appendChild(option);
                            });
                            uniqueSchools.forEach(school => {
                                const option = document.createElement('option');
                                option.value = school;
                                option.textContent = school;
                                schoolFilter.appendChild(option);
                            });

                            applyFilters();
                        },
                        error: (error) => {
                            errorDiv.textContent = `CSV ဖိုင်ဖွင့်ရာတွင် အမှားဖြစ်ပါတယ်: ${error.message}`;
                            console.error('CSV parsing error:', error);
                        }
                    });
                })
                .catch(error => {
                    errorDiv.textContent = `CSV ဖိုင်ကို ရှာမတွေ့ပါ သို့မဟုတ် ချိတ်ဆက်၍မရပါ: ${error.message}`;
                    console.error('Fetch error:', error);
                });
        };

        const applyFilters = () => {
            const tableBody = document.getElementById('studentBody');
            const totalCountDiv = document.getElementById('totalCount');
            const classFilterValue = document.getElementById('classFilter').value;
            const schoolFilterValue = document.getElementById('schoolFilter').value;
            const subjectCountFilterValue = document.getElementById('subjectCountFilter').value;
            const customSubjectFilter = document.getElementById('customSubjectFilter');
            const customSubjectValue = customSubjectFilter.value;

            const filteredData = allData.filter(student => {
                const subjectCount = [student.P, student.TH, student.N, student.O].filter(Boolean).length;
                let subjectMatch = true;

                if (subjectCountFilterValue === 'custom' && customSubjectValue) {
                    subjectMatch = !!student[customSubjectValue];
                } else if (subjectCountFilterValue && subjectCountFilterValue !== 'custom') {
                    const requiredCount = parseInt(subjectCountFilterValue);
                    subjectMatch = subjectCount === requiredCount;
                }

                return (!classFilterValue || student.Class === classFilterValue) &&
                       (!schoolFilterValue || student.School === schoolFilterValue) &&
                       subjectMatch;
            });

            // Count monks and novices
            const monksCount = filteredData.filter(student => !student.Name.startsWith('ရှင်')).length;
            const novicesCount = filteredData.filter(student => student.Name.startsWith('ရှင်')).length;

            totalCountDiv.innerHTML = `
                <span>စုစုပေါင်း: <strong class="text-amber-400">${filteredData.length}</strong> ပါး</span> | 
                <span>ရဟန်း: <strong class="text-amber-400">${monksCount}</strong> ပါး</span> | 
                <span>သာမဏေ: <strong class="text-amber-400">${novicesCount}</strong> ပါး</span>
            `;
            
            tableBody.innerHTML = '';
            // Sort by C_Num if classFilter is selected
            const sortedData = classFilterValue ? [...filteredData].sort((a, b) => {
                const numA = a.C_Num ? parseInt(a.C_Num.replace(/\D/g,''), 10) : Infinity;
                const numB = b.C_Num ? parseInt(b.C_Num.replace(/\D/g,''), 10) : Infinity;
                return numA - numB;
            }) : filteredData;

            if (sortedData.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 9;
                cell.textContent = 'ရှာဖွေမှုနှင့် ကိုက်ညီသော အချက်အလက်များ မရှိပါ။';
                cell.className = 'text-center text-gray-500';
                row.appendChild(cell);
                tableBody.appendChild(row);
            } else {
                sortedData.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-gray-400">${index + 1}</td>
                        <td class="font-semibold text-white">${student.Name}</td>
                        <td>${student.Class}</td>
                        <td>${student.School}</td>
                        <td>${student.C_Num}</td>
                        <td class="text-center">${student.P ? '✔️' : ''}</td>
                        <td class="text-center">${student.TH ? '✔️' : ''}</td>
                        <td class="text-center">${student.N ? '✔️' : ''}</td>
                        <td class="text-center">${student.O ? '✔️' : ''}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // Show/hide custom subject filter based on selection
            customSubjectFilter.style.display = (subjectCountFilterValue === 'custom') ? 'inline-block' : 'none';
        };

        const copyTable = () => {
            const table = document.getElementById('studentTable');
            const classFilter = document.getElementById('classFilter').value;
            const schoolFilter = document.getElementById('schoolFilter').value;
            const subjectCountFilter = document.getElementById('subjectCountFilter').value;
            const customSubjectFilter = document.getElementById('customSubjectFilter').value;
            const totalCountText = document.getElementById('totalCount').textContent.trim().replace(/\s+/g, ' ');
            
            let text = '';
            // Custom header based on filters
            text += `၁၃၈၇-၂၀၂၅-ခုနှစ် ပါဠိတက္ကသိုလ်ညောင်တုန်းကျောင်းတိုက် သံဃာစာရင်း\n`;
            text += `အတန်း: ${classFilter || 'အားလုံး'} | ကျောင်း: ${schoolFilter || 'အားလုံး'} | ဘာသာရပ်: ${subjectCountFilter === 'custom' ? customSubjectFilter : (subjectCountFilter || 'အားလုံး')}\n`;
            text += `${totalCountText}\n\n`;

            const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent).join('\t');
            text += headers + '\n';
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent);
                text += cells.join('\t') + '\n';
            });
            navigator.clipboard.writeText(text)
                .then(() => alert('စာရင်းကို အောင်မြင်စွာ ကူးယူပြီးပါပြီ!'))
                .catch(err => {
                    console.error('Copy failed:', err);
                    alert('စာရင်းကူးယူရာတွင် အမှားအယွင်းဖြစ်သွားပါသည်။');
                });
        };

        // Load data when page loads
        window.onload = loadStudents;
    </script>
</body>
</html>
